name: Deploy to AWS

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'  # Trigger prod deployment on version tags like v1.0.0
  pull_request:
    types: [labeled]  # Deploy dev when PR is labeled with 'deploy-dev'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - staging
        - prod

env:
  PYTHON_VERSION: '3.12'
  PULUMI_STATE_BUCKET: snow-tracker-pulumi-state-us-west-2

jobs:
  # Determine which environment to deploy to
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should_deploy: ${{ steps.set-env.outputs.should_deploy }}
    steps:
      - name: Set environment based on trigger
        id: set-env
        run: |
          # Manual workflow dispatch
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Manual deployment to ${{ github.event.inputs.environment }}"

          # Version tag -> prod
          elif [ "${{ github.ref_type }}" = "tag" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Deploying to PROD from tag: ${{ github.ref_name }}"

          # Push to main -> staging (auto-deploy)
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Deploying to STAGING from main branch"

          # PR labeled with 'deploy-dev' -> dev
          elif [ "${{ github.event_name }}" = "pull_request" ] && [ "${{ github.event.label.name }}" = "deploy-dev" ]; then
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Deploying to DEV from PR #${{ github.event.pull_request.number }}"

          else
            echo "environment=none" >> $GITHUB_OUTPUT
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy to ${{ needs.determine-environment.outputs.environment }}
    needs: determine-environment
    if: needs.determine-environment.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    environment: ${{ needs.determine-environment.outputs.environment }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Set up Node.js (for website build)
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Install Pulumi CLI
      run: |
        curl -fsSL https://get.pulumi.com | sh
        echo "$HOME/.pulumi/bin" >> $GITHUB_PATH

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2

    - name: Install infrastructure dependencies with uv
      run: |
        cd infrastructure
        uv pip install --system -r requirements.txt

    - name: Set environment variables
      run: |
        echo "ENVIRONMENT=${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_ENV
        echo "PULUMI_CONFIG_PASSPHRASE=${{ secrets.PULUMI_CONFIG_PASSPHRASE }}" >> $GITHUB_ENV

    # NOTE: Removed aggressive cleanup that was destroying all resources.
    # API Gateway URL now stays stable across deployments.
    # If you have orphaned resources, clean them up manually or use pulumi destroy.

    - name: Deploy infrastructure
      run: |
        cd infrastructure

        # Use S3 backend for state (falls back to local if bucket doesn't exist yet)
        if aws s3 ls "s3://${{ env.PULUMI_STATE_BUCKET }}" 2>/dev/null; then
          pulumi login s3://${{ env.PULUMI_STATE_BUCKET }}
        else
          echo "S3 state bucket not found, using local backend for bootstrap"
          pulumi login --local
        fi

        # Create or select stack
        pulumi stack select ${{ env.ENVIRONMENT }} || pulumi stack init ${{ env.ENVIRONMENT }}

        # Cancel any stale locks from previous failed runs
        pulumi cancel --yes 2>/dev/null || true

        # Set configuration
        pulumi config set aws:region us-west-2
        pulumi config set snow-tracker-infrastructure:env ${{ env.ENVIRONMENT }}
        pulumi config set snow-tracker-infrastructure:appName snow-tracker

        # Configure APNs if credentials are available
        if [ -n "${{ secrets.APNS_KEY_ID }}" ] && [ -n "${{ secrets.APNS_PRIVATE_KEY }}" ]; then
          echo "Configuring APNs credentials..."
          pulumi config set snow-tracker-infrastructure:apnsKeyId "${{ secrets.APNS_KEY_ID }}"
          # Use environment variable and printf to handle multiline content
          export APNS_KEY='${{ secrets.APNS_PRIVATE_KEY }}'
          printf '%s' "$APNS_KEY" | pulumi config set --secret snow-tracker-infrastructure:apnsPrivateKey --
          unset APNS_KEY
          pulumi config set snow-tracker-infrastructure:apnsTeamId "${APNS_TEAM_ID:-N324UX8D9M}"
          pulumi config set snow-tracker-infrastructure:apnsBundleId "com.wouterdevriendt.snowtracker"
          echo "APNs credentials configured"
        else
          echo "APNs credentials not set - push notifications will not be available"
        fi

        # Deploy - Pulumi will update existing resources in place
        pulumi up --yes --diff

    - name: Package Lambda functions with pip
      run: |
        cd backend
        mkdir -p dist
        # Use requirements-lambda.txt with Linux platform for Lambda compatibility
        pip install -q -r requirements-lambda.txt --target dist/ --platform manylinux2014_x86_64 --python-version 3.12 --only-binary :all:
        cp -r src/* dist/
        cd dist && zip -r ../lambda-package.zip . && cd ..

    - name: Upload Lambda package
      uses: actions/upload-artifact@v4
      with:
        name: lambda-package-${{ env.ENVIRONMENT }}
        path: backend/lambda-package.zip

    - name: Deploy Lambda code and configure
      run: |
        cd infrastructure

        # Upload Lambda package to S3 (required for packages > 50MB)
        S3_BUCKET="${{ env.PULUMI_STATE_BUCKET }}"
        S3_KEY="lambda-packages/${{ env.ENVIRONMENT }}/lambda-package-$(date +%Y%m%d%H%M%S).zip"
        echo "Uploading Lambda package to s3://$S3_BUCKET/$S3_KEY"
        aws s3 cp ../backend/lambda-package.zip "s3://$S3_BUCKET/$S3_KEY"

        # Deploy API Handler Lambda
        API_LAMBDA=$(pulumi stack output api_handler_lambda_name 2>/dev/null || echo "")
        APNS_PLATFORM_ARN=$(pulumi stack output apns_platform_app_arn 2>/dev/null || echo "")
        if [ -n "$API_LAMBDA" ]; then
          echo "Deploying API handler Lambda: $API_LAMBDA"
          aws lambda update-function-code \
            --function-name "$API_LAMBDA" \
            --s3-bucket "$S3_BUCKET" \
            --s3-key "$S3_KEY" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$API_LAMBDA" --region us-west-2

          # Update API Lambda environment variables (including APNS_PLATFORM_APP_ARN for debug endpoints)
          aws lambda update-function-configuration \
            --function-name "$API_LAMBDA" \
            --environment "Variables={ENVIRONMENT=${{ env.ENVIRONMENT }},RESORTS_TABLE=snow-tracker-resorts-${{ env.ENVIRONMENT }},WEATHER_CONDITIONS_TABLE=snow-tracker-weather-conditions-${{ env.ENVIRONMENT }},USER_PREFERENCES_TABLE=snow-tracker-user-preferences-${{ env.ENVIRONMENT }},FEEDBACK_TABLE=snow-tracker-feedback-${{ env.ENVIRONMENT }},DEVICE_TOKENS_TABLE=snow-tracker-device-tokens-${{ env.ENVIRONMENT }},RESORT_EVENTS_TABLE=snow-tracker-resort-events-${{ env.ENVIRONMENT }},AWS_REGION_NAME=us-west-2,APNS_PLATFORM_APP_ARN=$APNS_PLATFORM_ARN}" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$API_LAMBDA" --region us-west-2
          echo "API handler Lambda updated"
        fi

        # Deploy Weather Processor Lambda
        WEATHER_LAMBDA=$(pulumi stack output weather_processor_lambda_name 2>/dev/null || echo "")
        if [ -n "$WEATHER_LAMBDA" ]; then
          echo "Deploying Weather processor Lambda: $WEATHER_LAMBDA"
          aws lambda update-function-code \
            --function-name "$WEATHER_LAMBDA" \
            --s3-bucket "$S3_BUCKET" \
            --s3-key "$S3_KEY" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$WEATHER_LAMBDA" --region us-west-2

          # Update Weather Lambda environment variables with Weather API key and parallel processing config
          aws lambda update-function-configuration \
            --function-name "$WEATHER_LAMBDA" \
            --environment "Variables={ENVIRONMENT=${{ env.ENVIRONMENT }},RESORTS_TABLE=snow-tracker-resorts-${{ env.ENVIRONMENT }},WEATHER_CONDITIONS_TABLE=snow-tracker-weather-conditions-${{ env.ENVIRONMENT }},SNOW_SUMMARY_TABLE=snow-tracker-snow-summary-${{ env.ENVIRONMENT }},AWS_REGION_NAME=us-west-2,WEATHER_API_KEY=${{ secrets.WEATHER_API_KEY }},PARALLEL_PROCESSING=true,WEATHER_WORKER_LAMBDA=snow-tracker-weather-worker-${{ env.ENVIRONMENT }}}" \
            --region us-west-2
          # Wait for configuration update to complete before invoking
          aws lambda wait function-updated --function-name "$WEATHER_LAMBDA" --region us-west-2
          echo "Weather processor Lambda updated"
        fi

        # Deploy Weather Worker Lambda (for parallel processing)
        WORKER_LAMBDA=$(pulumi stack output weather_worker_lambda_name 2>/dev/null || echo "")
        if [ -n "$WORKER_LAMBDA" ]; then
          echo "Deploying Weather worker Lambda: $WORKER_LAMBDA"
          aws lambda update-function-code \
            --function-name "$WORKER_LAMBDA" \
            --s3-bucket "$S3_BUCKET" \
            --s3-key "$S3_KEY" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$WORKER_LAMBDA" --region us-west-2

          # Update Worker Lambda environment variables
          aws lambda update-function-configuration \
            --function-name "$WORKER_LAMBDA" \
            --environment "Variables={ENVIRONMENT=${{ env.ENVIRONMENT }},RESORTS_TABLE=snow-tracker-resorts-${{ env.ENVIRONMENT }},WEATHER_CONDITIONS_TABLE=snow-tracker-weather-conditions-${{ env.ENVIRONMENT }},SNOW_SUMMARY_TABLE=snow-tracker-snow-summary-${{ env.ENVIRONMENT }},AWS_REGION_NAME=us-west-2,ENABLE_SCRAPING=true}" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$WORKER_LAMBDA" --region us-west-2
          echo "Weather worker Lambda updated"
        fi

        # Deploy Notification Processor Lambda
        NOTIFICATION_LAMBDA=$(pulumi stack output notification_processor_lambda_name 2>/dev/null || echo "")
        APNS_PLATFORM_ARN=$(pulumi stack output apns_platform_app_arn 2>/dev/null || echo "")
        if [ -n "$NOTIFICATION_LAMBDA" ]; then
          echo "Deploying Notification processor Lambda: $NOTIFICATION_LAMBDA"
          aws lambda update-function-code \
            --function-name "$NOTIFICATION_LAMBDA" \
            --s3-bucket "$S3_BUCKET" \
            --s3-key "$S3_KEY" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$NOTIFICATION_LAMBDA" --region us-west-2

          # Update Notification Lambda environment variables
          aws lambda update-function-configuration \
            --function-name "$NOTIFICATION_LAMBDA" \
            --environment "Variables={ENVIRONMENT=${{ env.ENVIRONMENT }},USER_PREFERENCES_TABLE=snow-tracker-user-preferences-${{ env.ENVIRONMENT }},DEVICE_TOKENS_TABLE=snow-tracker-device-tokens-${{ env.ENVIRONMENT }},WEATHER_CONDITIONS_TABLE=snow-tracker-weather-conditions-${{ env.ENVIRONMENT }},RESORT_EVENTS_TABLE=snow-tracker-resort-events-${{ env.ENVIRONMENT }},RESORTS_TABLE=snow-tracker-resorts-${{ env.ENVIRONMENT }},AWS_REGION_NAME=us-west-2,APNS_PLATFORM_APP_ARN=$APNS_PLATFORM_ARN}" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$NOTIFICATION_LAMBDA" --region us-west-2
          echo "Notification processor Lambda updated"
        fi

        # Deploy Scraper Orchestrator Lambda
        SCRAPER_ORCHESTRATOR=$(pulumi stack output scraper_orchestrator_lambda_name 2>/dev/null || echo "")
        if [ -n "$SCRAPER_ORCHESTRATOR" ]; then
          echo "Deploying Scraper orchestrator Lambda: $SCRAPER_ORCHESTRATOR"
          aws lambda update-function-code \
            --function-name "$SCRAPER_ORCHESTRATOR" \
            --s3-bucket "$S3_BUCKET" \
            --s3-key "$S3_KEY" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$SCRAPER_ORCHESTRATOR" --region us-west-2

          # Update Scraper Orchestrator Lambda environment variables
          aws lambda update-function-configuration \
            --function-name "$SCRAPER_ORCHESTRATOR" \
            --environment "Variables={ENVIRONMENT=${{ env.ENVIRONMENT }},RESORTS_TABLE=snow-tracker-resorts-${{ env.ENVIRONMENT }},SCRAPER_WORKER_LAMBDA=snow-tracker-scraper-worker-${{ env.ENVIRONMENT }},RESULTS_BUCKET=snow-tracker-pulumi-state-us-west-2,AWS_REGION_NAME=us-west-2}" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$SCRAPER_ORCHESTRATOR" --region us-west-2
          echo "Scraper orchestrator Lambda updated"
        fi

        # Deploy Scraper Worker Lambda
        SCRAPER_WORKER=$(pulumi stack output scraper_worker_lambda_name 2>/dev/null || echo "")
        NEW_RESORTS_TOPIC=$(pulumi stack output new_resorts_topic_arn 2>/dev/null || echo "")
        if [ -n "$SCRAPER_WORKER" ]; then
          echo "Deploying Scraper worker Lambda: $SCRAPER_WORKER"
          aws lambda update-function-code \
            --function-name "$SCRAPER_WORKER" \
            --s3-bucket "$S3_BUCKET" \
            --s3-key "$S3_KEY" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$SCRAPER_WORKER" --region us-west-2

          # Update Scraper Worker Lambda environment variables
          aws lambda update-function-configuration \
            --function-name "$SCRAPER_WORKER" \
            --environment "Variables={ENVIRONMENT=${{ env.ENVIRONMENT }},RESORTS_TABLE=snow-tracker-resorts-${{ env.ENVIRONMENT }},RESULTS_BUCKET=snow-tracker-pulumi-state-us-west-2,AWS_REGION_NAME=us-west-2,NEW_RESORTS_TOPIC_ARN=$NEW_RESORTS_TOPIC}" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$SCRAPER_WORKER" --region us-west-2
          echo "Scraper worker Lambda updated"
        fi

        # Deploy Scraper Results Processor Lambda
        SCRAPER_RESULTS_PROCESSOR=$(pulumi stack output scraper_results_processor_lambda_name 2>/dev/null || echo "")
        if [ -n "$SCRAPER_RESULTS_PROCESSOR" ]; then
          echo "Deploying Scraper results processor Lambda: $SCRAPER_RESULTS_PROCESSOR"
          aws lambda update-function-code \
            --function-name "$SCRAPER_RESULTS_PROCESSOR" \
            --s3-bucket "$S3_BUCKET" \
            --s3-key "$S3_KEY" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$SCRAPER_RESULTS_PROCESSOR" --region us-west-2

          # Update Scraper Results Processor Lambda environment variables
          aws lambda update-function-configuration \
            --function-name "$SCRAPER_RESULTS_PROCESSOR" \
            --environment "Variables={ENVIRONMENT=${{ env.ENVIRONMENT }},RESORTS_TABLE=snow-tracker-resorts-${{ env.ENVIRONMENT }},RESULTS_BUCKET=snow-tracker-pulumi-state-us-west-2,AWS_REGION_NAME=us-west-2}" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$SCRAPER_RESULTS_PROCESSOR" --region us-west-2
          echo "Scraper results processor Lambda updated"
        fi

        # Deploy Version Consolidator Lambda
        VERSION_CONSOLIDATOR=$(pulumi stack output version_consolidator_lambda_name 2>/dev/null || echo "")
        RESORT_UPDATES_TOPIC=$(pulumi stack output resort_updates_topic_arn 2>/dev/null || echo "")
        if [ -n "$VERSION_CONSOLIDATOR" ]; then
          echo "Deploying Version consolidator Lambda: $VERSION_CONSOLIDATOR"
          aws lambda update-function-code \
            --function-name "$VERSION_CONSOLIDATOR" \
            --s3-bucket "$S3_BUCKET" \
            --s3-key "$S3_KEY" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$VERSION_CONSOLIDATOR" --region us-west-2

          # Update Version Consolidator Lambda environment variables
          aws lambda update-function-configuration \
            --function-name "$VERSION_CONSOLIDATOR" \
            --environment "Variables={ENVIRONMENT=${{ env.ENVIRONMENT }},RESORTS_TABLE=snow-tracker-resorts-${{ env.ENVIRONMENT }},RESULTS_BUCKET=snow-tracker-pulumi-state-us-west-2,AWS_REGION_NAME=us-west-2,RESORT_UPDATES_TOPIC_ARN=$RESORT_UPDATES_TOPIC}" \
            --region us-west-2
          aws lambda wait function-updated --function-name "$VERSION_CONSOLIDATOR" --region us-west-2
          echo "Version consolidator Lambda updated"
        fi

        echo "Lambda deployment complete"

    - name: Seed resort data (dev/staging only)
      if: env.ENVIRONMENT == 'dev' || env.ENVIRONMENT == 'staging'
      run: |
        cd backend
        uv pip install --system -r requirements.txt
        PYTHONPATH=src python scripts/seed_resorts.py --summary
        PYTHONPATH=src python scripts/seed_resorts.py
      env:
        RESORTS_TABLE: snow-tracker-resorts-${{ env.ENVIRONMENT }}
        AWS_DEFAULT_REGION: us-west-2

    - name: Build and deploy website (prod only)
      if: env.ENVIRONMENT == 'prod'
      run: |
        cd website

        # Install dependencies and build
        npm ci
        npm run build

        # Get bucket name and CloudFront distribution ID from Pulumi
        cd ../infrastructure
        WEBSITE_BUCKET=$(pulumi stack output website_bucket_name 2>/dev/null || echo "")
        CLOUDFRONT_ID=$(pulumi stack output cloudfront_distribution_id 2>/dev/null || echo "")

        if [ -n "$WEBSITE_BUCKET" ]; then
          echo "Deploying website to S3 bucket: $WEBSITE_BUCKET"
          aws s3 sync ../website/dist/ "s3://$WEBSITE_BUCKET/" --delete

          if [ -n "$CLOUDFRONT_ID" ]; then
            echo "Invalidating CloudFront cache: $CLOUDFRONT_ID"
            aws cloudfront create-invalidation \
              --distribution-id "$CLOUDFRONT_ID" \
              --paths "/*"
          fi

          echo "Website deployed successfully!"
        else
          echo "Website bucket not available, skipping website deployment"
        fi

    - name: Invoke weather processor to fetch initial data (async)
      run: |
        cd infrastructure
        WEATHER_LAMBDA=$(pulumi stack output weather_processor_lambda_name 2>/dev/null || echo "")

        if [ -n "$WEATHER_LAMBDA" ]; then
          echo "Invoking weather processor asynchronously: $WEATHER_LAMBDA"
          # Use --invocation-type Event for async invocation (doesn't wait for completion)
          aws lambda invoke \
            --function-name "$WEATHER_LAMBDA" \
            --invocation-type Event \
            --region us-west-2 \
            --payload '{}' \
            /tmp/weather-response.json

          echo "Weather processor triggered (running in background)"
          echo "Check CloudWatch logs for progress: /aws/lambda/$WEATHER_LAMBDA"
        else
          echo "Weather processor Lambda name not available"
        fi

    - name: Run smoke tests
      run: |
        # Wait for deployment to be ready
        sleep 30

        # Get API Gateway URL from Pulumi outputs
        cd infrastructure
        API_URL=$(pulumi stack output api_gateway_url 2>/dev/null || echo "")

        if [ -n "$API_URL" ]; then
          echo "Testing API at: $API_URL"

          # Test health endpoint
          curl -f "$API_URL/health" || echo "Health check failed"

          # Test resorts endpoint
          curl -f "$API_URL/api/v1/resorts" || echo "Resorts endpoint failed"
        else
          echo "API URL not available, skipping smoke tests"
        fi

    - name: Import Grafana Dashboards
      if: env.ENVIRONMENT == 'staging'
      run: |
        # Get Grafana workspace info
        WORKSPACE_INFO=$(aws grafana list-workspaces \
          --query "workspaces[?name=='snow-tracker-grafana'].[id,endpoint]" \
          --output text 2>/dev/null || echo "")

        if [ -n "$WORKSPACE_INFO" ] && [ "$WORKSPACE_INFO" != "None" ]; then
          WORKSPACE_ID=$(echo "$WORKSPACE_INFO" | awk '{print $1}')
          WORKSPACE_URL=$(echo "$WORKSPACE_INFO" | awk '{print $2}')

          echo "Creating temporary Grafana API key..."
          # Create a short-lived API key (5 min) for dashboard import
          API_KEY=$(aws grafana create-workspace-api-key \
            --workspace-id "$WORKSPACE_ID" \
            --key-name "ci-deploy-$(date +%s)" \
            --key-role ADMIN \
            --seconds-to-live 300 \
            --query 'key' --output text 2>/dev/null || echo "")

          if [ -n "$API_KEY" ]; then
            echo "Importing dashboards to Grafana: $WORKSPACE_URL"
            chmod +x infrastructure/scripts/import-grafana-dashboards.sh
            GRAFANA_WORKSPACE_URL="https://$WORKSPACE_URL" \
            GRAFANA_API_KEY="$API_KEY" \
              infrastructure/scripts/import-grafana-dashboards.sh
          else
            echo "Could not create Grafana API key (check IAM permissions)"
          fi
        else
          echo "Grafana workspace not found, skipping dashboard import"
        fi

    - name: Deployment Summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ env.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Region**: us-west-2" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.ref_type }}" = "tag" ]; then
          echo "- **Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        fi
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployed at**: $(date -u)" >> $GITHUB_STEP_SUMMARY

        cd infrastructure
        API_URL=$(pulumi stack output api_gateway_url 2>/dev/null || echo "Not available")
        echo "- **API URL**: $API_URL" >> $GITHUB_STEP_SUMMARY

        # Add custom domain URLs for prod
        if [ "${{ env.ENVIRONMENT }}" = "prod" ]; then
          WEBSITE_URL=$(pulumi stack output website_url 2>/dev/null || echo "")
          API_CUSTOM_URL=$(pulumi stack output api_url_custom 2>/dev/null || echo "")
          if [ -n "$WEBSITE_URL" ]; then
            echo "- **Website**: $WEBSITE_URL" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -n "$API_CUSTOM_URL" ]; then
            echo "- **API (Custom Domain)**: $API_CUSTOM_URL" >> $GITHUB_STEP_SUMMARY
          fi
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Deployment Strategy" >> $GITHUB_STEP_SUMMARY
        echo "| Environment | Trigger |" >> $GITHUB_STEP_SUMMARY
        echo "|-------------|---------|" >> $GITHUB_STEP_SUMMARY
        echo "| dev | Manual dispatch, PR label 'deploy-dev', or localhost |" >> $GITHUB_STEP_SUMMARY
        echo "| staging | Auto-deploy on merge to main |" >> $GITHUB_STEP_SUMMARY
        echo "| prod | Manual dispatch or git tag (v*) |" >> $GITHUB_STEP_SUMMARY
