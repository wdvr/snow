name: Populate Resorts Database

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - prod
        default: staging
      source:
        description: 'Data source file'
        required: true
        type: choice
        options:
          - data/resorts.json
          - data/resorts_scraped.json
        default: data/resorts.json
      update_existing:
        description: 'Update existing resorts (not just create new)'
        required: false
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (preview only)'
        required: false
        type: boolean
        default: false
      notify:
        description: 'Send SNS notification'
        required: false
        type: boolean
        default: true

jobs:
  populate:
    runs-on: ubuntu-latest
    env:
      ENVIRONMENT: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Get SNS Topic ARN
        id: get-sns
        if: github.event.inputs.notify == 'true'
        run: |
          cd infrastructure
          pip install pulumi pulumi-aws -q
          pulumi login s3://snow-tracker-pulumi-state-us-west-2 --non-interactive 2>/dev/null || pulumi login --local
          pulumi stack select ${{ github.event.inputs.environment }} 2>/dev/null || true
          SNS_ARN=$(pulumi stack output resort_updates_topic_arn 2>/dev/null || echo "")
          echo "sns_arn=$SNS_ARN" >> $GITHUB_OUTPUT
        env:
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}

      - name: Populate resorts (dry run)
        if: github.event.inputs.dry_run == 'true'
        working-directory: backend
        env:
          RESORTS_TABLE: snow-tracker-resorts-${{ github.event.inputs.environment }}
          PYTHONPATH: ${{ github.workspace }}/backend/src
        run: |
          echo "=== DRY RUN - Preview only ==="
          UPDATE_FLAG=""
          if [ "${{ github.event.inputs.update_existing }}" == "true" ]; then
            UPDATE_FLAG="--update-existing"
          fi
          python scripts/populate_resorts.py \
            --source ${{ github.event.inputs.source }} \
            --dry-run \
            --detect-removed \
            $UPDATE_FLAG \
            --verbose

      - name: Populate resorts
        if: github.event.inputs.dry_run != 'true'
        working-directory: backend
        env:
          RESORTS_TABLE: snow-tracker-resorts-${{ github.event.inputs.environment }}
          PYTHONPATH: ${{ github.workspace }}/backend/src
          SNS_TOPIC_ARN: ${{ steps.get-sns.outputs.sns_arn }}
        run: |
          NOTIFY_FLAG=""
          if [ "${{ github.event.inputs.notify }}" == "true" ] && [ -n "$SNS_TOPIC_ARN" ]; then
            NOTIFY_FLAG="--notify"
          fi

          UPDATE_FLAG=""
          if [ "${{ github.event.inputs.update_existing }}" == "true" ]; then
            UPDATE_FLAG="--update-existing"
          fi

          python scripts/populate_resorts.py \
            --source ${{ github.event.inputs.source }} \
            --detect-removed \
            $NOTIFY_FLAG \
            $UPDATE_FLAG \
            --environment ${{ github.event.inputs.environment }} \
            --verbose

      - name: Summary
        run: |
          echo "=== Populate Summary ==="
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Dry run: ${{ github.event.inputs.dry_run }}"
          echo "Notify: ${{ github.event.inputs.notify }}"
          echo ""
          echo "Source file stats:"
          python -c "
          import json
          with open('backend/data/resorts_scraped.json') as f:
              data = json.load(f)
          resorts = data.get('resorts', [])
          print(f'Total resorts: {len(resorts)}')
          zero_coords = sum(1 for r in resorts if r.get('latitude', 0) == 0 and r.get('longitude', 0) == 0)
          print(f'With valid coords: {len(resorts) - zero_coords}')
          print(f'Needing geocoding: {zero_coords}')
          "
