name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '18'
  # Runner Configuration - Easy switches
  USE_SELF_HOSTED: 'true'
  ENABLE_FALLBACK: 'true'

# Permissions for reading files, PRs, and checking runners
permissions:
  contents: read
  pull-requests: read
  actions: read

jobs:
  # Check runner availability and determine strategy
  runner-strategy:
    name: Check Runner Availability
    runs-on: ubuntu-latest
    outputs:
      runner: ${{ steps.check.outputs.runner }}
      runner-label: ${{ steps.check.outputs.runner-label }}
    steps:
    - name: Check self-hosted runner availability
      id: check
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Configuration: USE_SELF_HOSTED=${{ env.USE_SELF_HOSTED }}, ENABLE_FALLBACK=${{ env.ENABLE_FALLBACK }}"

        if [ "${{ env.USE_SELF_HOSTED }}" != "true" ]; then
          echo "Self-hosted disabled by configuration"
          echo "runner=macos-26" >> $GITHUB_OUTPUT
          echo "runner-label=github-hosted" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "Checking for self-hosted runners..."
        RUNNERS=$(gh api repos/${{ github.repository }}/actions/runners --jq '.runners[] | select(.status=="online") | select(.labels[].name=="macOS" or .labels[].name=="self-hosted") | .name' 2>/dev/null || echo "")

        if [ -n "$RUNNERS" ]; then
          echo "âœ… Found online self-hosted runner(s): $RUNNERS"
          echo "runner=self-hosted" >> $GITHUB_OUTPUT
          echo "runner-label=self-hosted" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ No self-hosted runners available"
          if [ "${{ env.ENABLE_FALLBACK }}" == "true" ]; then
            echo "Falling back to GitHub-hosted runner"
            echo "runner=macos-26" >> $GITHUB_OUTPUT
            echo "runner-label=github-hosted-fallback" >> $GITHUB_OUTPUT
          else
            echo "Fallback disabled - will attempt self-hosted anyway"
            echo "runner=self-hosted" >> $GITHUB_OUTPUT
            echo "runner-label=self-hosted-required" >> $GITHUB_OUTPUT
          fi
        fi

  # Detect which components changed
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      ios: ${{ steps.filter.outputs.ios }}
      infrastructure: ${{ steps.filter.outputs.infrastructure }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          backend:
            - 'backend/**'
            - '.github/workflows/ci.yml'
          ios:
            - 'ios/**'
            - '.github/workflows/ci.yml'
          infrastructure:
            - 'infrastructure/**'
            - '.github/workflows/ci.yml'
            - '.github/workflows/deploy.yml'

  # Backend Python Tests
  backend-tests:
    name: Backend Tests
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest

    services:
      dynamodb:
        image: amazon/dynamodb-local:latest
        ports:
          - 8000:8000
        options: >-
          --health-cmd "curl -sf http://localhost:8000/shell/ || exit 0"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 10s

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Install backend dependencies with uv
      run: |
        cd backend
        uv pip install --system -e .
        uv pip install --system -r requirements.txt
        uv pip install --system pytest-cov pytest-mock moto[dynamodb] localstack-client httpx

    - name: Set up environment variables
      run: |
        echo "RESORTS_TABLE=snow-tracker-resorts-test" >> $GITHUB_ENV
        echo "WEATHER_CONDITIONS_TABLE=snow-tracker-weather-conditions-test" >> $GITHUB_ENV
        echo "USER_PREFERENCES_TABLE=snow-tracker-user-preferences-test" >> $GITHUB_ENV
        echo "WEATHER_API_KEY=test-key" >> $GITHUB_ENV
        echo "AWS_DEFAULT_REGION=us-west-2" >> $GITHUB_ENV
        echo "AWS_ACCESS_KEY_ID=test" >> $GITHUB_ENV
        echo "AWS_SECRET_ACCESS_KEY=test" >> $GITHUB_ENV

    - name: Run unit tests with coverage
      run: |
        cd backend
        python -m pytest tests/ --ignore=tests/integration/ -v \
          --ignore=tests/test_resort_seeder.py \
          --cov=src \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --cov-fail-under=30 \
          --tb=short \
          -k "not test_elevation_point_invalid_coordinates and not test_resort_computed_properties and not test_weather_condition_computed_properties and not test_get_resort_statistics and not test_get_current_weather_api_error and not test_assess_excellent_conditions and not test_time_degradation_score and not test_confidence_level_adjustment and not test_data_completeness_assessment"

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: ./backend/coverage.xml
        flags: backend
        name: backend-coverage
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Run integration tests
      run: |
        cd backend
        python -m pytest tests/integration/ -v --tb=short
      env:
        DYNAMODB_ENDPOINT: http://localhost:8000

    - name: Archive coverage reports
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: backend/htmlcov/

  # Infrastructure Validation
  infrastructure-validation:
    name: Infrastructure Validation
    needs: changes
    if: ${{ needs.changes.outputs.infrastructure == 'true' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Install Pulumi CLI
      run: |
        curl -fsSL https://get.pulumi.com | sh
        echo "$HOME/.pulumi/bin" >> $GITHUB_PATH

    - name: Install infrastructure dependencies with uv
      run: |
        cd infrastructure
        uv pip install --system -r requirements.txt

    - name: Validate Pulumi Python syntax
      run: |
        cd infrastructure
        python -m py_compile __main__.py
        echo "âœ… Infrastructure code syntax is valid"

    - name: Configure AWS credentials (optional)
      uses: aws-actions/configure-aws-credentials@v4
      continue-on-error: true
      id: aws-creds
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-west-2

    - name: Validate Pulumi configuration
      if: steps.aws-creds.outcome == 'success'
      run: |
        cd infrastructure
        pulumi login --local
        pulumi stack init test-stack || true
        pulumi config set aws:region us-west-2
        pulumi preview --diff --non-interactive
      env:
        PULUMI_CONFIG_PASSPHRASE: "test"

    - name: Skip Pulumi preview (no AWS credentials)
      if: steps.aws-creds.outcome != 'success'
      run: |
        echo "âš ï¸ AWS credentials not configured - skipping Pulumi preview"
        echo "Infrastructure Python code validated successfully"

  # Code Quality Checks
  code-quality:
    name: Code Quality
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        version: "latest"

    - name: Install linting dependencies with uv
      run: |
        uv pip install --system black flake8 mypy isort bandit ruff

    - name: Check code formatting with Black (non-blocking)
      continue-on-error: true
      run: |
        cd backend
        black --check --diff src/ tests/ || echo "âš ï¸ Code formatting issues found"

    - name: Check import sorting with isort (non-blocking)
      continue-on-error: true
      run: |
        cd backend
        isort --check-only --diff src/ tests/ || echo "âš ï¸ Import sorting issues found"

    - name: Lint with flake8
      continue-on-error: true
      run: |
        cd backend
        flake8 src/ tests/ --max-line-length=120 --extend-ignore=E203,W503,E501 --statistics

    - name: Lint with Ruff
      run: |
        cd backend
        ruff check src/ tests/ --ignore=E501,F401,F841,UP035,UP042,B904 --output-format=github

    - name: Type checking with mypy (non-blocking)
      continue-on-error: true
      run: |
        cd backend
        mypy src/ --ignore-missing-imports --no-strict-optional || echo "âš ï¸ Type checking issues found"

    - name: Security scanning with bandit
      run: |
        cd backend
        bandit -r src/ -f json -o bandit-report.json -ll || true
        bandit -r src/ --severity-level high -f txt

    - name: Upload security scan results
      uses: actions/upload-artifact@v4
      with:
        name: security-scan
        path: backend/bandit-report.json
        if-no-files-found: ignore

  # iOS Tests with intelligent runner selection
  ios-tests:
    name: iOS Tests (${{ needs.runner-strategy.outputs.runner-label }})
    needs: [changes, runner-strategy]
    if: ${{ needs.changes.outputs.ios == 'true' }}
    runs-on: ${{ needs.runner-strategy.outputs.runner == 'self-hosted' && fromJSON('["self-hosted", "macOS", "ARM64"]') || 'macos-26' }}
    timeout-minutes: 30

    steps:
    - name: Runner Info
      run: |
        echo "ðŸ–¥ï¸ Runner: ${{ needs.runner-strategy.outputs.runner-label }}"
        echo "OS: $(uname -s) $(uname -r)"
        echo "Arch: $(uname -m)"
        echo "Host: $(hostname)"

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Select Xcode
      run: |
        # Find and select Xcode (prefer Xcode 26.x, fall back to latest)
        XCODE_PATH=$(ls -d /Applications/Xcode_26*.app 2>/dev/null | sort -V | tail -1)
        if [ -z "$XCODE_PATH" ]; then
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
        fi
        if [ -z "$XCODE_PATH" ]; then
          XCODE_PATH="/Applications/Xcode.app"
        fi

        if [ -d "$XCODE_PATH" ]; then
          echo "Using Xcode: $XCODE_PATH"
          sudo xcode-select -s "$XCODE_PATH/Contents/Developer" || true
          export DEVELOPER_DIR="$XCODE_PATH/Contents/Developer"
        else
          echo "WARNING: No Xcode found, using default"
        fi

        xcodebuild -version
        xcrun --show-sdk-version --sdk iphoneos || true

    - name: Install XcodeGen
      run: |
        if ! command -v xcodegen &> /dev/null; then
          brew install xcodegen
        fi

    - name: Generate Xcode project
      run: |
        cd ios
        if [ -f "project.yml" ]; then
          xcodegen generate
        fi

    - name: Find Available Simulator
      id: simulator
      run: |
        for SIM in "iPhone 17" "iPhone 17 Pro" "iPhone 16" "iPhone 16 Pro" "iPhone 15" "iPhone 15 Pro"; do
          if xcrun simctl list devices available | grep -q "$SIM"; then
            echo "simulator=$SIM" >> $GITHUB_OUTPUT
            echo "Found simulator: $SIM"
            exit 0
          fi
        done
        SIM=$(xcrun simctl list devices available | grep "iPhone" | head -1 | sed 's/^[[:space:]]*//' | cut -d'(' -f1 | xargs)
        echo "simulator=$SIM" >> $GITHUB_OUTPUT
        echo "Using fallback simulator: $SIM"

    - name: Boot simulator
      run: |
        DEVICE_ID=$(xcrun simctl list devices available | grep "${{ steps.simulator.outputs.simulator }}" | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')
        if [ -n "$DEVICE_ID" ]; then
          xcrun simctl boot "$DEVICE_ID" || true
        fi

    - name: Run iOS Unit Tests
      run: |
        cd ios
        set -o pipefail
        xcodebuild test \
          -project SnowTracker.xcodeproj \
          -scheme SnowTracker \
          -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.simulator }}" \
          -only-testing:SnowTrackerTests \
          -resultBundlePath TestResults/UnitTests.xcresult \
          CODE_SIGNING_ALLOWED=NO \
          2>&1 | tee build.log | head -500
      continue-on-error: true

    - name: Run iOS UI Tests
      run: |
        cd ios
        xcodebuild test \
          -project SnowTracker.xcodeproj \
          -scheme SnowTracker \
          -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.simulator }}" \
          -only-testing:SnowTrackerUITests \
          -resultBundlePath TestResults/UITests.xcresult \
          CODE_SIGNING_ALLOWED=NO \
          2>&1 | tee -a build.log | head -500
      continue-on-error: true

    - name: Capture Screenshots
      if: always()
      run: |
        mkdir -p ios/TestResults/Screenshots
        if [ -d "ios/TestResults/UITests.xcresult" ]; then
          find ios/TestResults/UITests.xcresult -name "*.png" -exec cp {} ios/TestResults/Screenshots/ \; 2>/dev/null || true
        fi
        xcrun simctl io booted screenshot ios/TestResults/Screenshots/final_state.png 2>/dev/null || true

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ios-test-results-${{ needs.runner-strategy.outputs.runner-label }}
        path: |
          ios/TestResults/
          ios/build.log

  # Build and Test Results Summary
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [changes, backend-tests, infrastructure-validation, code-quality, ios-tests]
    if: always()

    steps:
    - name: Test Results Summary
      run: |
        echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

        BACKEND="${{ needs.backend-tests.result }}"
        IOS="${{ needs.ios-tests.result }}"
        INFRA="${{ needs.infrastructure-validation.result }}"
        QUALITY="${{ needs.code-quality.result }}"

        [ "$BACKEND" = "skipped" ] && BACKEND="â­ï¸ skipped (no changes)"
        [ "$IOS" = "skipped" ] && IOS="â­ï¸ skipped (no changes)"
        [ "$INFRA" = "skipped" ] && INFRA="â­ï¸ skipped (no changes)"
        [ "$QUALITY" = "skipped" ] && QUALITY="â­ï¸ skipped (no changes)"

        echo "| Backend Tests | $BACKEND |" >> $GITHUB_STEP_SUMMARY
        echo "| iOS Tests | $IOS |" >> $GITHUB_STEP_SUMMARY
        echo "| Infrastructure Validation | $INFRA |" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | $QUALITY |" >> $GITHUB_STEP_SUMMARY

        FAILED=false
        for result in "${{ needs.backend-tests.result }}" "${{ needs.ios-tests.result }}" "${{ needs.infrastructure-validation.result }}" "${{ needs.code-quality.result }}"; do
          if [ "$result" = "failure" ]; then
            FAILED=true
            break
          fi
        done

        if [ "$FAILED" = "true" ]; then
          echo "âŒ Some checks failed." >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
        fi
