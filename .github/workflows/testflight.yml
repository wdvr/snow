name: Deploy to TestFlight

on:
  # Trigger after CI Pipeline completes successfully on main
  workflow_run:
    workflows: ["CI Pipeline"]
    branches: [main]
    types:
      - completed
  # Manual trigger for emergency deployments
  workflow_dispatch:
    inputs:
      build_number_increment:
        description: 'Increment build number by'
        required: false
        default: '1'
        type: string

env:
  SCHEME: 'SnowTracker'
  PROJECT_PATH: 'ios/SnowTracker.xcodeproj'

jobs:
  build-and-upload:
    name: Build and Upload to TestFlight
    runs-on: macos-15
    # Only run if CI passed (or if manually triggered)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # For workflow_run, we need to checkout the commit that triggered the workflow
        ref: ${{ github.event.workflow_run.head_sha || github.sha }}

    - name: Select Xcode 26
      run: |
        # List available Xcode versions
        ls -la /Applications/ | grep Xcode || true
        # Select Xcode 26 (required for iOS 26 SDK)
        if [ -d "/Applications/Xcode_26.app" ]; then
          sudo xcode-select -s /Applications/Xcode_26.app/Contents/Developer
        elif [ -d "/Applications/Xcode-26.app" ]; then
          sudo xcode-select -s /Applications/Xcode-26.app/Contents/Developer
        elif [ -d "/Applications/Xcode.app" ]; then
          # Check if default Xcode is version 26
          XCODE_VERSION=$(xcodebuild -version | head -1 | awk '{print $2}')
          echo "Default Xcode version: $XCODE_VERSION"
          if [[ ! "$XCODE_VERSION" =~ ^26 ]]; then
            echo "Warning: Xcode 26 not found, using available version"
          fi
        fi
        xcode-select -p
        xcodebuild -version
        # Verify SDK version
        xcodebuild -showsdks | grep iOS || true

    - name: Install XcodeGen
      run: brew install xcodegen

    - name: Generate Xcode project
      run: |
        cd ios
        xcodegen generate

    - name: Resolve Swift Package Dependencies
      run: |
        xcodebuild -resolvePackageDependencies \
          -project ${{ env.PROJECT_PATH }} \
          -scheme ${{ env.SCHEME }}

    - name: Increment build number
      run: |
        cd ios
        # Get current build number and increment
        CURRENT_BUILD=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" SnowTracker/Info.plist 2>/dev/null || echo "1")
        NEW_BUILD=$((CURRENT_BUILD + ${{ github.event.inputs.build_number_increment || 1 }}))
        echo "Incrementing build number from $CURRENT_BUILD to $NEW_BUILD"

        # Update Info.plist
        /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $NEW_BUILD" SnowTracker/Info.plist

        # Also update widget if exists
        if [ -f "SnowTrackerWidget/Info.plist" ]; then
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $NEW_BUILD" SnowTrackerWidget/Info.plist
        fi

    - name: Setup App Store Connect API Key
      run: |
        mkdir -p ~/.private_keys
        echo "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}" | tr -d '\r' > ~/.private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
        chmod 600 ~/.private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8

    - name: Install certificates
      env:
        DISTRIBUTION_CERTIFICATE_BASE64: ${{ secrets.DISTRIBUTION_CERTIFICATE_BASE64 }}
        DISTRIBUTION_CERTIFICATE_PASSWORD: ${{ secrets.DISTRIBUTION_CERTIFICATE_PASSWORD }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # Create temporary keychain
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # Import certificate
        CERTIFICATE_PATH=$RUNNER_TEMP/certificate.p12
        echo -n "$DISTRIBUTION_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
        security import $CERTIFICATE_PATH -P "$DISTRIBUTION_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # Add to keychain search list
        security list-keychain -d user -s $KEYCHAIN_PATH login.keychain-db

    - name: Archive app
      run: |
        xcodebuild archive \
          -project ${{ env.PROJECT_PATH }} \
          -scheme ${{ env.SCHEME }} \
          -configuration Release \
          -archivePath ~/Export/SnowTracker.xcarchive \
          -destination 'generic/platform=iOS' \
          -allowProvisioningUpdates \
          -authenticationKeyPath ~/.private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
          -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
          -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }} \
          CODE_SIGN_STYLE=Automatic \
          DEVELOPMENT_TEAM=N324UX8D9M

    - name: Create ExportOptions.plist
      run: |
        cat > /tmp/ExportOptions.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store-connect</string>
            <key>teamID</key>
            <string>N324UX8D9M</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>uploadSymbols</key>
            <true/>
            <key>destination</key>
            <string>upload</string>
        </dict>
        </plist>
        EOF

    - name: Export and Upload to TestFlight
      run: |
        xcodebuild -exportArchive \
          -archivePath ~/Export/SnowTracker.xcarchive \
          -exportPath ~/Export \
          -exportOptionsPlist /tmp/ExportOptions.plist \
          -allowProvisioningUpdates \
          -authenticationKeyPath ~/.private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8 \
          -authenticationKeyID ${{ secrets.APP_STORE_CONNECT_KEY_ID }} \
          -authenticationKeyIssuerID ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}

    - name: Upload to TestFlight Summary
      run: |
        echo "## TestFlight Upload Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Scheme**: ${{ env.SCHEME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.event.workflow_run.head_sha || github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Uploaded at**: $(date -u)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Check [App Store Connect](https://appstoreconnect.apple.com) for the build status." >> $GITHUB_STEP_SUMMARY

    - name: Cleanup
      if: always()
      run: |
        rm -rf ~/.private_keys
        rm -rf ~/Export
        # Delete temporary keychain
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true
