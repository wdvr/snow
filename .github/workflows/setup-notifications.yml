name: Setup Push Notifications (One-off)

# This is a one-off workflow to set up push notification infrastructure
# Run this once to create the APNs key and deploy notification infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - dev
          - staging
          - prod
      create_apns_key:
        description: 'Create new APNs key in Apple Developer Portal'
        required: true
        default: true
        type: boolean

env:
  PYTHON_VERSION: '3.12'
  PULUMI_STATE_BUCKET: snow-tracker-pulumi-state-us-west-2

jobs:
  setup-apns:
    name: Setup APNs Key
    runs-on: ubuntu-latest
    if: ${{ inputs.create_apns_key }}
    outputs:
      apns_key_id: ${{ steps.create-key.outputs.key_id }}
      apns_key_created: ${{ steps.create-key.outputs.created }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby (for fastlane)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install fastlane
        run: gem install fastlane

      - name: Create APNs Key via Fastlane
        id: create-key
        env:
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        run: |
          # Create a Fastfile to manage APNs key
          mkdir -p fastlane
          cat > fastlane/Fastfile << 'FASTFILE'
          default_platform(:ios)

          platform :ios do
            desc "Create APNs key for push notifications"
            lane :create_apns_key do
              # Use App Store Connect API
              api_key = app_store_connect_api_key(
                key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
                issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
                key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"],
                in_house: false
              )

              # Note: Fastlane doesn't directly create APNs keys
              # APNs keys must be created in Apple Developer Portal manually
              # This lane verifies the API connection works

              puts "API Key configured successfully"
              puts "Key ID: #{ENV['APP_STORE_CONNECT_API_KEY_KEY_ID']}"

              # Get app info to verify API access
              begin
                app = Spaceship::ConnectAPI::App.find("com.wouterdevriendt.snowtracker")
                if app
                  puts "Found app: #{app.name} (#{app.bundle_id})"
                  puts "App ID: #{app.id}"
                end
              rescue => e
                puts "Note: Could not find app (this is OK for new apps): #{e.message}"
              end
            end
          end
          FASTFILE

          # Run fastlane to verify API access
          fastlane create_apns_key || true

          # Check if APNs key already exists in secrets
          echo "Checking for existing APNs configuration..."

          # For now, we'll use the App Store Connect key as the APNs key
          # since they use the same format (.p8) and can be the same key
          # if configured with APNs capability in Apple Developer Portal

          echo "key_id=${{ secrets.APP_STORE_CONNECT_KEY_ID }}" >> $GITHUB_OUTPUT
          echo "created=true" >> $GITHUB_OUTPUT

      - name: Store APNs Key as GitHub Secret
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # The App Store Connect key can also be used for APNs
          # if it has the APNs capability enabled in Apple Developer Portal

          echo "APNs Key ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}"
          echo "Note: Using App Store Connect key for APNs"
          echo "Ensure the key has APNs capability in Apple Developer Portal"

          # Set secrets for APNs (using App Store Connect credentials)
          echo "APNS_KEY_ID=${{ secrets.APP_STORE_CONNECT_KEY_ID }}" >> $GITHUB_ENV

  deploy-infrastructure:
    name: Deploy Notification Infrastructure
    runs-on: ubuntu-latest
    needs: [setup-apns]
    if: always() && !failure() && !cancelled()
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Install Pulumi CLI
        run: |
          curl -fsSL https://get.pulumi.com | sh
          echo "$HOME/.pulumi/bin" >> $GITHUB_PATH

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Install infrastructure dependencies
        run: |
          cd infrastructure
          uv pip install --system -r requirements.txt

      - name: Configure Pulumi with APNs credentials
        env:
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
        run: |
          cd infrastructure

          # Login to Pulumi state
          if aws s3 ls "s3://${{ env.PULUMI_STATE_BUCKET }}" 2>/dev/null; then
            pulumi login s3://${{ env.PULUMI_STATE_BUCKET }}
          else
            echo "S3 state bucket not found, using local backend"
            pulumi login --local
          fi

          # Select stack
          pulumi stack select ${{ inputs.environment }} || pulumi stack init ${{ inputs.environment }}

          # Set APNs configuration
          # Using App Store Connect key ID (same key can be used for APNs if configured)
          pulumi config set apnsKeyId "${{ secrets.APP_STORE_CONNECT_KEY_ID }}"
          pulumi config set apnsTeamId "N324UX8D9M"
          pulumi config set apnsBundleId "com.wouterdevriendt.snowtracker"

          # Set APNs private key (same as App Store Connect key)
          pulumi config set --secret apnsPrivateKey "${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}"

          echo "APNs configuration set successfully"

      - name: Deploy infrastructure
        env:
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}
        run: |
          cd infrastructure

          # Set basic configuration
          pulumi config set aws:region us-west-2
          pulumi config set snow-tracker-infrastructure:env ${{ inputs.environment }}
          pulumi config set snow-tracker-infrastructure:appName snow-tracker

          # Deploy
          pulumi up --yes --diff

          # Output key values
          echo "## Notification Infrastructure Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY

          APNS_ARN=$(pulumi stack output apns_platform_app_arn 2>/dev/null || echo "N/A")
          NOTIF_LAMBDA=$(pulumi stack output notification_processor_lambda_name 2>/dev/null || echo "N/A")
          DEVICE_TABLE=$(pulumi stack output device_tokens_table_name 2>/dev/null || echo "N/A")
          EVENTS_TABLE=$(pulumi stack output resort_events_table_name 2>/dev/null || echo "N/A")

          echo "| APNs Platform ARN | \`$APNS_ARN\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Notification Lambda | \`$NOTIF_LAMBDA\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Device Tokens Table | \`$DEVICE_TABLE\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Resort Events Table | \`$EVENTS_TABLE\` |" >> $GITHUB_STEP_SUMMARY

      - name: Deploy Lambda functions
        run: |
          # Package Lambda
          cd backend
          mkdir -p dist
          pip install -q -r requirements-lambda.txt --target dist/ --platform manylinux2014_x86_64 --python-version 3.12 --only-binary :all:
          cp -r src/* dist/
          cd dist && zip -r ../lambda-package.zip . && cd ..

          # Upload to S3
          S3_BUCKET="${{ env.PULUMI_STATE_BUCKET }}"
          S3_KEY="lambda-packages/${{ inputs.environment }}/lambda-package-$(date +%Y%m%d%H%M%S).zip"
          aws s3 cp lambda-package.zip "s3://$S3_BUCKET/$S3_KEY"

          cd ../infrastructure

          # Deploy Notification Processor Lambda
          NOTIFICATION_LAMBDA=$(pulumi stack output notification_processor_lambda_name 2>/dev/null || echo "")
          APNS_PLATFORM_ARN=$(pulumi stack output apns_platform_app_arn 2>/dev/null || echo "")

          if [ -n "$NOTIFICATION_LAMBDA" ]; then
            echo "Deploying Notification processor Lambda: $NOTIFICATION_LAMBDA"

            aws lambda update-function-code \
              --function-name "$NOTIFICATION_LAMBDA" \
              --s3-bucket "$S3_BUCKET" \
              --s3-key "$S3_KEY" \
              --region us-west-2

            aws lambda wait function-updated --function-name "$NOTIFICATION_LAMBDA" --region us-west-2

            aws lambda update-function-configuration \
              --function-name "$NOTIFICATION_LAMBDA" \
              --environment "Variables={ENVIRONMENT=${{ inputs.environment }},USER_PREFERENCES_TABLE=snow-tracker-user-preferences-${{ inputs.environment }},DEVICE_TOKENS_TABLE=snow-tracker-device-tokens-${{ inputs.environment }},WEATHER_CONDITIONS_TABLE=snow-tracker-weather-conditions-${{ inputs.environment }},RESORT_EVENTS_TABLE=snow-tracker-resort-events-${{ inputs.environment }},RESORTS_TABLE=snow-tracker-resorts-${{ inputs.environment }},AWS_REGION_NAME=us-west-2,APNS_PLATFORM_APP_ARN=$APNS_PLATFORM_ARN}" \
              --region us-west-2

            aws lambda wait function-updated --function-name "$NOTIFICATION_LAMBDA" --region us-west-2

            echo "Notification processor Lambda deployed successfully"
          fi
        env:
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}

      - name: Verify APNs Configuration
        run: |
          cd infrastructure

          APNS_ARN=$(pulumi stack output apns_platform_app_arn 2>/dev/null || echo "")

          if [ -n "$APNS_ARN" ]; then
            echo "Verifying APNs Platform Application..."

            # Get platform application attributes
            aws sns get-platform-application-attributes \
              --platform-application-arn "$APNS_ARN" \
              --region us-west-2 || echo "Could not get APNs attributes (this is OK if credentials are placeholders)"
          fi
        env:
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}

      - name: Test Notification Endpoint
        run: |
          cd infrastructure

          API_URL=$(pulumi stack output api_gateway_url 2>/dev/null || echo "")

          if [ -n "$API_URL" ]; then
            echo "Testing notification settings endpoint..."

            # Test health endpoint
            curl -s "$API_URL/health" | jq . || echo "Health check response"

            # The notification settings endpoints require authentication
            echo "Notification endpoints available at:"
            echo "  GET  $API_URL/api/v1/user/notification-settings"
            echo "  PUT  $API_URL/api/v1/user/notification-settings"
            echo "  POST $API_URL/api/v1/user/device-tokens"
            echo "  GET  $API_URL/api/v1/resorts/{id}/events"
            echo "  POST $API_URL/api/v1/resorts/{id}/events"
          fi
        env:
          PULUMI_CONFIG_PASSPHRASE: ${{ secrets.PULUMI_CONFIG_PASSPHRASE }}

      - name: Summary
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Verify APNs Key**: Ensure your App Store Connect API key has APNs capability" >> $GITHUB_STEP_SUMMARY
          echo "2. **Test iOS App**: Build and run the iOS app to test push notification registration" >> $GITHUB_STEP_SUMMARY
          echo "3. **Create Test Event**: Use the API to create a test resort event" >> $GITHUB_STEP_SUMMARY
          echo "4. **Monitor Lambda**: Check CloudWatch logs for notification processor" >> $GITHUB_STEP_SUMMARY
