# Fastlane configuration for Snow Tracker (Powder Chaser)

default_platform(:ios)

platform :ios do
  # ============================================
  # Build & TestFlight
  # ============================================

  desc "Build and upload to TestFlight"
  lane :beta do |options|
    api_key = get_api_key

    # Increment build number
    increment_build_number(
      xcodeproj: "SnowTracker.xcodeproj"
    )

    # Build the app
    build_app(
      project: "SnowTracker.xcodeproj",
      scheme: "SnowTracker",
      export_method: "app-store",
      clean: true,
      output_directory: "./build",
      output_name: "SnowTracker.ipa"
    )

    # Upload to TestFlight
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: options[:skip_wait] || false,
      distribute_external: false
    )

    # Commit the version bump
    commit_version_bump(
      xcodeproj: "SnowTracker.xcodeproj",
      message: "Bump build number for TestFlight",
      force: true
    )
  end

  desc "Build and upload to TestFlight (quick - skip processing wait)"
  lane :beta_quick do
    beta(skip_wait: true)
  end

  # ============================================
  # Full Release Workflow
  # ============================================

  desc "Full release: build, upload to TestFlight, upload metadata, submit for review"
  lane :release do |options|
    api_key = get_api_key
    version = get_version_number(xcodeproj: "SnowTracker.xcodeproj", target: "SnowTracker")

    UI.message("Releasing version #{version}")

    # 1. Increment build number
    increment_build_number(xcodeproj: "SnowTracker.xcodeproj")
    build_number = get_build_number(xcodeproj: "SnowTracker.xcodeproj")
    UI.message("Build number: #{build_number}")

    # 2. Build the app
    UI.message("Building app...")
    build_app(
      project: "SnowTracker.xcodeproj",
      scheme: "SnowTracker",
      export_method: "app-store",
      clean: true,
      output_directory: "./build",
      output_name: "SnowTracker.ipa"
    )

    # 3. Upload to TestFlight (App Store Connect)
    UI.message("Uploading to App Store Connect...")
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: false
    )

    # 4. Generate screenshots (optional - can skip if already have them)
    unless options[:skip_screenshots]
      UI.message("Generating screenshots...")
      begin
        screenshots
      rescue => e
        UI.important("Screenshot generation failed: #{e.message}")
        UI.important("Continuing without new screenshots...")
      end
    end

    # 5. Upload metadata and screenshots
    UI.message("Uploading metadata...")
    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.snowtracker",
      app_version: version,
      skip_binary_upload: true,
      skip_screenshots: options[:skip_screenshots] || false,
      skip_metadata: false,
      force: true,
      precheck_include_in_app_purchases: false,
      submit_for_review: false,
      automatic_release: false,
      run_precheck_before_submit: false,
      overwrite_screenshots: true
    )

    # 6. Submit for review
    UI.message("Submitting for App Store review...")
    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.snowtracker",
      app_version: version,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: true,
      submit_for_review: true,
      automatic_release: true,
      force: true,
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )

    # 7. Commit version bump
    commit_version_bump(
      xcodeproj: "SnowTracker.xcodeproj",
      message: "Release version #{version} (#{build_number})",
      force: true
    )

    # 8. Tag the release
    add_git_tag(tag: "v#{version}-#{build_number}")

    UI.success("Successfully submitted version #{version} for review!")
  end

  desc "Release without screenshots (faster)"
  lane :release_no_screenshots do
    release(skip_screenshots: true)
  end

  desc "Submit existing build for review (metadata only)"
  lane :submit_for_review do |options|
    api_key = get_api_key
    version = options[:version] || get_version_number(xcodeproj: "SnowTracker.xcodeproj", target: "SnowTracker")

    # Upload metadata first
    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.snowtracker",
      app_version: version,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      force: true,
      run_precheck_before_submit: false
    )

    # Submit for review
    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.snowtracker",
      app_version: version,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: true,
      submit_for_review: true,
      automatic_release: true,
      force: true,
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )

    UI.success("Submitted version #{version} for review!")
  end

  # ============================================
  # Screenshot Generation
  # ============================================

  desc "Generate App Store screenshots on all required device sizes"
  lane :screenshots do
    # Ensure we have the UI tests scheme
    capture_screenshots(
      project: "SnowTracker.xcodeproj",
      scheme: "SnowTracker",
      testplan: "ScreenshotTestPlan",
      devices: [
        "iPhone 17 Pro Max",      # 6.9" display (required)
        "iPhone 17 Pro",          # 6.3" display
        "iPhone 16e"              # smaller display
      ],
      languages: ["en-US"],
      output_directory: "./screenshots",
      clear_previous_screenshots: true,
      override_status_bar: true,
      concurrent_simulators: false,
      stop_after_first_error: false,
      skip_open_summary: true
    )
  end

  desc "Generate screenshots for iPhone only (faster)"
  lane :screenshots_iphone do
    capture_screenshots(
      project: "SnowTracker.xcodeproj",
      scheme: "SnowTracker",
      testplan: "ScreenshotTestPlan",
      devices: ["iPhone 17 Pro Max"],
      languages: ["en-US"],
      output_directory: "./screenshots",
      clear_previous_screenshots: true,
      override_status_bar: true,
      skip_open_summary: true
    )
  end

  # ============================================
  # App Store Connect Upload
  # ============================================

  desc "Upload metadata, screenshots, and app icon to App Store Connect"
  lane :deliver_metadata do |options|
    api_key = get_api_key

    # Get version from options or project
    version = options[:app_version] || get_version_number(xcodeproj: "SnowTracker.xcodeproj", target: "SnowTracker")

    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.snowtracker",
      app_version: version,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true,
      precheck_include_in_app_purchases: false,
      submit_for_review: false,
      automatic_release: false,
      run_precheck_before_submit: false,
      overwrite_screenshots: true
    )
  end

  desc "Upload only screenshots"
  lane :upload_screenshots do
    api_key = get_api_key

    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.snowtracker",
      skip_binary_upload: true,
      skip_metadata: true,
      skip_screenshots: false,
      skip_app_version_update: true,
      force: true,
      run_precheck_before_submit: false,
      overwrite_screenshots: true
    )
  end

  desc "Upload only the app icon"
  lane :upload_icon do
    api_key = get_api_key

    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.snowtracker",
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: true,
      app_icon: "./metadata/app_icon.png",
      force: true,
      submit_for_review: false,
      run_precheck_before_submit: false
    )
  end

  desc "Upload only metadata (no screenshots)"
  lane :upload_metadata_only do |options|
    api_key = get_api_key

    version = options[:app_version] || get_version_number(xcodeproj: "SnowTracker.xcodeproj", target: "SnowTracker")

    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.snowtracker",
      app_version: version,
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      force: true,
      run_precheck_before_submit: false
    )
  end

  desc "Download existing metadata from App Store Connect"
  lane :download_metadata do
    api_key = get_api_key

    deliver(
      api_key: api_key,
      app_identifier: "com.wouterdevriendt.snowtracker",
      skip_binary_upload: true,
      skip_screenshots: true,
      skip_metadata: false,
      force: true,
      run_precheck_before_submit: false,
      download_metadata: true
    )
  end

  # ============================================
  # Version Management
  # ============================================

  desc "Bump version number (major, minor, or patch)"
  lane :bump_version do |options|
    bump_type = options[:type] || "patch"

    increment_version_number(
      xcodeproj: "SnowTracker.xcodeproj",
      bump_type: bump_type
    )

    version = get_version_number(xcodeproj: "SnowTracker.xcodeproj", target: "SnowTracker")
    UI.success("Bumped version to #{version}")
  end

  desc "Set specific version number"
  lane :set_version do |options|
    version = options[:version]
    unless version
      UI.user_error!("Please provide version number: fastlane set_version version:X.Y.Z")
    end

    increment_version_number(
      xcodeproj: "SnowTracker.xcodeproj",
      version_number: version
    )

    UI.success("Set version to #{version}")
  end

  # ============================================
  # Combined Workflows
  # ============================================

  desc "Generate screenshots and upload everything"
  lane :prepare_and_upload do
    screenshots
    deliver_metadata
  end

  desc "Full App Store preparation: icons, screenshots, metadata"
  lane :full_app_store_prep do |options|
    # Generate icons using Python script
    Dir.chdir("../..") do
      sh("python3 scripts/generate_icons.py")
    end

    # Generate screenshots
    screenshots unless options[:skip_screenshots]

    # Upload everything
    deliver_metadata
  end

  # ============================================
  # Helpers
  # ============================================

  private_lane :get_api_key do
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: ENV["APP_STORE_CONNECT_KEY_PATH"],
      in_house: false
    )
  end
end

# Error handling
error do |lane, exception|
  UI.error("Error in lane '#{lane}': #{exception.message}")
end
